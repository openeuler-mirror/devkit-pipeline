# 批量部署工具

获取本项目release包 `devkit-pipeline-${tag}.tar.gz` 文件 ，将其上传至linux服务器后解压，获取解压后linux文件夹内文件列表如下图：

![image-文件列表](image/批量部署工具和一键下载工具说明文档/image-文件列表.png)



其中 **`deploy_tool`** 为批量部署工具，**`download_tool`** 为一键下载工具。**`machine.yaml`**文件为两个工具倚赖的配置文件，具体填写内容说明见下文。在无网络环境下一键下载工具为部署工具提供所需组件包下载能力，windows版本下载工具支持在windows机器上下载组件包（注：windows版本下载工具在release文件列表内的名称为**`download_tool-for-windows.exe`**）。



> [**最新版下载链接**](https://gitee.com/openeuler/devkit-pipeline/releases/tag/v1.0)

> 注：配置流水线时，流水线使用哪个用户来执行，就需要使用该用户来执行一键部署工具。



## machine.yaml 配置文件

源码仓提供该配置文件模板为

```yaml
user: root
pkey: /root/.ssh/id_rsa
scanner:
  - 192.168.0.1
  - 192.168.0.2
  - 192.168.0.3
java_builder:
  - 192.168.0.1
c_cpp_buidler:
  - 192.168.0.1
executor:
  - 192.168.0.1
devkit:
  - 192.168.0.4
```

其中，**`user`** 需填写本结点至其他结点配置免密的用户名，**`pkey`** 为配置免密所用公钥对应的私钥路径。

**`scanner`**，**`java_builder`**，**`c_cpp_builder`**, **`executor`**，**`devkit`** 分别对应用户的扫描机，Java构建机，C/CPP构建机，执行机，devkit部署机器 ，需以yaml列表的形式输入各角色机器对应的ip。

- 生成公私钥对的命令为：

> ```shell
> ssh-keygen [-b bits] [-t rsa] [-f output_keyfile]
> ```
>
> 推荐使用rsa协议生成公私钥对，如下即为在当前路径下生成rsa公私钥对的命令：
>
> ```shell
> ssh-keygen -t rsa
> ```
>
> 在命令行输入上述命令后，命令回显会提示用户输入生成公私钥对所用密码，此处建议用户不输入密码，直接确认。
>
> 若输入密码，则后续批量部署工具在运行时需要用户手动输入密码，或在machine.yaml配置文件中新增一行password参数并填入公私钥对所用密码。

- 配置本结点至其他结点免密的命令为：

> ```shell
> ssh-copy-id -i id_rsa.pub USER@REMOTE_HOST
> ```
>
> USER 替换为远程服务器的用户名，REMOTE_HOST 替换为远程服务器的ip地址。ssh-copy-id命令使用 -i 选项指定用于配置免密的公钥路径。执行完该命令后，会提示输入远程服务器的密码。
>
> 输入远程服务器的密码后，公钥就会被复制到远程服务器的 authorized_keys 文件中，这样就可以实现无密码登录远程服务器的功能。
>
> <font color=red  size=5>**若上述ip中出现本机ip，或想要本机到本机的安装部署，则需要配置一遍本机到本机的免密登录。**</font>

- 部署执行LkpTests的executor执行机上的普通用户需要配置sudo权限与sudo免密

> 执行 visudo 命令，或编辑修改 /etc/sudoers 文件：
>
> 普通用户`USER`配置sudo权限，需在  /etc/sudoers 文件中对比 `root  ALL=(ALL)  ALL` 新增一行
>
> ```txt
> root    ALL=(ALL)       ALL
> USER    ALL=(ALL)       ALL
> ```
>
> 普通用户`USER`配置sudo免密，需在  /etc/sudoers 文件中对比 `# %wheel  ALL=(ALL) NOPASSWD: ALL` 新增一行
>
> ```txt
> # %wheel        ALL=(ALL)       NOPASSWD: ALL
> USER            ALL=(ALL)       NOPASSWD: ALL
> ```





## deploy_tool 批量部署工具

在命令行进入工具所在的文件夹路径，输入如下命令，可以查看该工具的使用提示。

```shell
./deploy_tool -h
```
![](image/批量部署工具和一键下载工具说明文档/image-批量部署工具使用提示.png)

除 **`-h`** 使用提示参数外，**`deploy_tool`** 批量部署工具还提供 **`-f`**，**`-iso`** ，**`--debug`** 三个参数。

- 使用`-f`参数，指定所需yaml配置文件为后续输入的路径。若不使用`-f`参数，批量部署工具默认会从当前路径下读取名为`machine.yaml`的文件作为yaml配置文件。 `-f`参数别名为`--config`。
- 使用 `-iso` 参数，指定要安装镜像源文件。使用该参数运行时，部署工具会在远端节点配置本地镜像后，进行组件安装。在组件安装完毕后，即删除刚刚配置好的本地镜像源，恢复初始环境。
- 使用 `--debug`参数，可以打开批量部署工具的debug日志信息，方便根据命令行日志输出确认哪个环节出现了问题。

注：本批量部署工具将标准输出作为日志输出地址，没有生成单独的日志文件。

#### 使用批量部署工具常用的命令为：

```shell
./deploy_tool -f ./machine.yaml --debug
```

```
./deploy_tool -f ./machine.yaml -iso /path/to/iso --debug
```

> <font color=red  size=5>**注意：使用部署工具，需要提前在目标节点安装 tar 命令用于安装组件。**</font>



#### 批量部署工具支持按角色批量部署组件，并支持根据iso镜像文件挂载本地镜像。

<font color=red>**按角色下载和部署对应组件：**</font>

| 角色          | 对应组件                                                     |
| ------------- | ------------------------------------------------------------ |
| scanner       | BiShengJDK17, DevKitCLI                                      |
| java_builder  | BiShengJDK17, BiShengJDK8                                    |
| c_cpp_buidler | GCCforOpenEuler, BiShengCompiler, BiShengJDK17, A-FOT, NonInvasiveSwitching |
| executor      | BiShengJDK17, LkpTests                                       |
| devkit        | DevKitWeb                                                    |



各工具下载版本多为2024年2月各工具官网提供的最新版，可查看本项目源代码`tools/download_dependency/src/download_config.py` 文件查看具体下载链接。

说明：**部署工具部署BiShengJDK8 和 BiShengJDK17时，两个版本的安装包解压在${HOME}/.local/目录下，用户可以按自己需要使用的版本进行手动配置环境变量**。

部署安装过程中会使用目标结点机器的 **`/tmp`** 目录作为临时文件所在目录，部署完成后将会删除 **`/tmp`** 目录下的临时文件。若目标结点机器 **`/tmp`** 目录磁盘空间不足，则会导致安装失败。若使用挂载本地镜像方式安装，则安装完依赖后，本地镜像源将被取消挂载并恢复原来的镜像源配置。



## download_tool 一键下载工具

当批量部署工具所在结点网络不通时，可以使用 **`download_tool`** 一键下载工具在有网络环境的机器上先行将所需的组件安装包及校验文件下载下来并打包成 **`devkitdependencies.tar.gz`** 文件，供用户上传至批量部署工具所在结点，供批量部署工具在默认路径加载使用。

 `devkitdependencies.tar.gz` 文件上传路径为`deploy_tool` 部署工具所在路径。上传完成后目录文件列表如下：

![image-组件包放置位置](image/批量部署工具和一键下载工具说明文档/image-组件包放置位置.png)

#### 一键下载工具linux版本

该工具在release包解压后的linux文件夹下，在Linux机器上使用，用于下载组件包。Linux版下载工具使用 `wget -c url` 进行下载组件，有断点续传的效果。

```shell
./download_tool -f machine.yaml
```

直接执行该命令即可按`machine.yaml`配置文件中有效角色下载 **GCCforOpenEuler**，**BiShengCompiler**，**BiShengJDK8**，**BiShengJDK17**，**lkp-tests**，**DevKitWeb**，**DevKitCLI** 组件。



> 在有网络环境的linux服务器上，一键下载工具所在路径，执行如下命令，可以查看该工具的使用提示。
>
> ```shell
> ./download_tool -h
> ```
>
> 除 **`-h`** 使用提示参数外，**`download`** 批量下载工具还提供 **`-iso`** 参数。
>
> - 使用 -iso 参数，指定下载iso版本，输入“auto”将自动检测操作系统版本，并自动下载对应的版本iso文件。
>

##### 使用下载工具常用的命令为：

> ```shell
> ./download_tool 
> ```
>
> 若要使用下载工具下载本地镜像，则可使用以下命令进行下载。（不常用）
>
> ```shell
> ./download_tool -iso auto
> ```
>



#### 一键下载工具windows版本

该工具在release文件列表内的名称为**`download_tool-for-windows.exe`**，可在windows机器上使用，用于下载组件包。

执行下载工具时需要将yaml配置文件在相同路径下创建一份。

![image-windows版本一键下载工具](image/批量部署工具和一键下载工具说明文档/image-windows版本一键下载工具.png)

**双击** 该`download_tool-for-windows.exe` 文件即可在当前目录下下载组件包。下载完成后结果如下：

![image-在windows机器上下载组件包](image/批量部署工具和一键下载工具说明文档/image-windows机器上下载组件包.png)



##### 使用下载工具常用的命令为：

> ```shell
> ./download_tool 
> ```
>
> 若要使用下载工具下载本地镜像，则可使用以下命令进行下载。（不常用）
>
> ```shell
> ./download_tool -iso openEuler_2203_LTS
> ```
>



## 部署结果

批量部署工具将各组件安装至用户家目录下的.local文件夹下。

#### GCCforOpenEuler 安装结果

批量部署工具将`GCCforOpenEuler`安装包解压至用户家目录下的.local文件夹下，并在用户的 `~/.bashrc` 文件中新增如下两行命令。用户重新登录服务器后即可查询当前环境所用`gcc`版本。

```shell
export GCC_HOME=${HOME}/.local/gcc-10.3.1-2023.12-aarch64-linux/bin
export PATH=${GCC_HOME}:${PATH}
```

#### BiShengCompiler安装结果

批量部署工具将`BiShengCompiler`安装包解压至用户家目录下的.local文件夹下，并在用户的 `~/.bashrc` 文件中新增如下两行命令。用户重新登录服务器后即可查询当前环境所用`clang`版本。

```shell
export BISHENG_COMPILER_HOME=${HOME}/.local/BiShengCompiler-3.2.0-aarch64-linux/bin
export PATH=${BISHENG_COMPILER_HOME}:${PATH}
```

#### BiShengJDK8安装结果

批量部署工具将`BiShengJDK8`安装包解压至用户家目录下的.local文件夹下，用户手动配置环境变量后，可使用如下命令查询当前环境所用`java`版本。

```shell
java -version
```

#### BiShengJDK17安装结果

批量部署工具将`BiShengJDK17`安装包解压至用户家目录下的.local文件夹下，用户手动配置环境变量后，可使用如下命令查询当前环境所用`java`版本。

```shell
java -version
```

#### 测试平台(lkp-tests)安装结果

可使用如下命令查看lkp安装位置。

```
which lkp
```

**A-FOT安装结果**

批量部署工具将`A-FOT`安装包解压至用户家目录下的.local文件夹下，并在用户的 `~/.bashrc` 文件中新增如下两行命令。用户重新登录服务器后，配置好配置文件后即可使用a-fot --config_file a-fot.ini（也可通过命令行灵活配置，详情请见[A-FOT指导文档](https://gitee.com/openeuler/devkit-pipeline/blob/master/document/A-FOT安装部署指导/A-FOT安装使用以及集成到Jenkins指导说明.md)）进行优化应用。

注意：**c_cpp_buidler角色、c/cpp构建机安装 a-fot 前需要预先使用yum安装 perf 命令。**

```shell
export A_FOT_HOME=${HOME}/.local/a-fot
export PATH=${A_FOT_HOME}:${PATH}
```

**clamAV安装结果**

批量部署工具将clamAV安装后，可使用如下命令查询当前环境所用`clamAV`版本。

```shell
clamscan -v
```

#### 无感切换依赖

如果用户的某些应用或命令希望使用本部署工具安装的 BiShengCompiler 编译器的相关环境变量，可以运行以下命令：

```
source /usr/local/wrap-bin/devkit_pipeline.sh
```