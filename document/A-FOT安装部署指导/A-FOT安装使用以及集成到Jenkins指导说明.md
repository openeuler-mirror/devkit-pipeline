# A-FOT安装使用以及集成到Jenkins指导说明

## 1.介绍

A-FOT(automatic feedback-directed optimization tool)是一款用于提升编译器openEuler GCC自动反馈优化特性易用性的工具。 该工具的目标是让用户通过较少的配置即可自动完成反馈优化的相关步骤（包括采样、分析、优化等），降低自动反馈优化特性的使用难度，享受反馈优化带来的性能提升。

## 2.特别提醒

1.用户需要自行完成应用的构建脚本（build_script）和执行脚本（run_script）。本工具会使用构建脚本完成应用的构建，使用执行脚本启动被优化的应用
2.本工具目前仅支持单实例应用优化，即应用在执行时只有一个进程
3.用户需保证执行脚本启动的应用程序测试用例与实际生产环境行为相同，否则可能会导致负优化

## 3.环境依赖需要满足以下条件：

1.编译器： GCC for openEuler2.3.2及以上

2.架构： 鲲鹏ARM

3.操作系统PRETTY_NAME：openEuler 22.03 LTS、openEuler 22.03（LTS-SP1）、openEuler 22.03（LTS-SP2）、openEuler 22.03（LTS-SP3）、Ubuntu 18.04.4 LTS、Ubuntu 20.04.2  LTS、Kylin  Linux Advanced  Server V10（Tercel）、UOS 20 、UnionTech OS  Server 20、CentOS Linux 7 (AltArch)。注：PRETTY_NAME为Centos Linux 7 (AltArch)操作系统的redhat-release值须是Centos Linux release 7.6.1810(Altarch)

4.软件包：perf

## 4.安装

1.git clone https://gitee.com/openeuler/A-FOT.git
2.yum install -y A-FOT (仅支持openEuler 22.03 LTS)

## 5.使用说明

### 1.填写配置项：在A-FOT根目录下找到a-fot.ini文件

```ini
# 文件和目录请使用绝对路径

# 优化模式（AutoFDO、AutoPrefetch、AutoBOLT、Auto_kernel_PGO（针对内核优化））
opt_mode=AutoPrefetch
# 脚本工作目录（用来编译应用程序/存放profile、日志）
work_path=/opt
# 应用运行脚本路径
run_script=/root/run.sh
# GCC路径（bin、lib的父目录）
gcc_path=/usr

# AutoFDO、AutoPrefetch、AutoBOLT
# 针对应用的三种优化模式，请填写此部分配置

# 应用进程名
application_name=test
# 二进制安装后可执行文件
bin_file=/tmp/test
# 应用构建脚本路径
build_script=/root/build.sh
# 最大二进制启动时间(单位：秒)
max_waiting_time=600
# Perf采样时长(单位：秒)
perf_time=100
# 检测是否优化成功(1=启用，0=禁用)
check_success=0
# 构建模式 （Bear、Wrapper）
build_mode=Wrapper

# auto_kernel_PGO
# 针对内核的优化模式，请填写此部分配置

# 内核PGO模式（arc=只启用arc profile，all=启用完整的PGO优化）
pgo_mode=all
# 执行阶段（1=编译插桩内核阶段，2=编译优化内核阶段）
pgo_phase=1
# 内核源码目录（不指定则自动下载）
kernel_src=/opt/kernel
# 内核构建的本地名（将根据阶段添加"-pgoing"或"-pgoed"后缀）
kernel_name=kernel
# 内核编译选项（请确保选项修改正确合法，不会造成内核编译失败）
#CONFIG_...=y
# 重启前的时间目录（用于将同一套流程的日志存放在一起）
last_time=
# 内核源码的Makefile地址（用于不自动编译内核的场景）
makefile=
# 内核配置文件路径（用于不自动编译内核的场景）
kernel_config=
# 内核生成的原始profile目录（用于不自动编译内核的场景）
data_dir=
```

***参数补充说明*：**

1）优化模式：

A-FOT是一款用于提升编译器GCC for openEuler自动反馈优化特性的工具，支持以下三种模式：

- AutoFDO

- AutoPrefetch

- AutoBOLT

  **说明：**

  - AutoFDO是PGO的简化部署版，使用perf替代插桩获取程序运行profile，受益优化点包括矢量化、循环展开、循环剥离等优化。
  - AutoPrefetch是增强版预取优化，根据Dcache访问、存取指令cache miss率，获取数据访问优化代码块并进行预取优化，同时优化预取提前量，建议和AutoFDO共同使用。
  - AutoBOLT是链接后二进制优化，对控制流复杂的程序具有显著的优化效果，主要优化包括BB重排、函数重排、冷热分区等优化，与AutoFDO、AutoPrefetch部分冲突。

2）构建模式

构建模式支持两种模式：

- Wrapper

- Bear

  **说明：**

  - 选择“Wrapper”构建模式，会使用A-FOT中的包装器编译。
  - 选择“Bear”构建模式，会进行两次编译。

3）脚本工作目录

在配置文件中，脚本工作目录示例在/opt下，实际应用中请修改为家目录或者./目录下

### 6.启动优化：

```shell
a-fot --config_file a-fot.ini
```

### 7.默认参数配置以a-fot.ini为基础，同时支持参数通过命令行灵活配置：

```shell
# 命令格式为 a-fot [OPTION1 ARG1] [OPTION2 ARG2]
# 例如以优化模式为AutoFDO,GCC路径/usr,应用运行脚本路径/root/run.sh,应用构建脚本路径/root/build.sh构建模式为Bear, 脚本工作目录为当前目录，命令如下
a-fot  --opt_mode AutoFDO  --gcc_path /usr --run_script /root/run.sh --build_script /root/build.sh --build_mode Wrapper --work_path ./
```

详细命令行参数如下：

```shell
Usage: a-fot [OPTION1 ARG1] [OPTION2 ARG2] [...]

For perf mode:（针对应用）
--config_file       Path of configuration file
--opt_mode          Optimization modes (AutoFDO/AutoPrefetch/AutoBOLT)
--perf_time         Perf sampling duration (unit: seconds)
--gcc_path          Compiler gcc path
--app_name          Application process name
--bin_file          Executable binary file path
--build_script      Application build script path
--work_path         Script working directory (used to compile the application and store the profile)
--run_script        Script path for running application
--max_waiting_time  Maximum binary startup time (unit: seconds)
--check_success     Check optimization result
--build_mode        Execute build script mode (Wrapper/Bear)

For kernel PGO mode:（针对内核）
--config_file       Path of configuration file
--opt_mode          Optimization mode (Auto_kernel_PGO)
--pgo_mode          PGO mode (arc/all)
--pgo_phase         Phase of kernel PGO (1/2)
--kernel_src        Kernel source directory
--kernel_name       Kernel local version name (will be appended with -pgoing or -pgoed)
--work_path         Script working directory (used to store the profile and the log)
--run_script        Script path for running application
--gcc_path          Compiler gcc path
--CONFIG_...        Kernel building configuration
--last_time         Last time directory before rebooting (used to put log infos together)
-s                  Silent mode (reboot automatically after kernel installation)
-n                  Do not compile kernel automatically
--makefile          Makefile path of kernel
--kernel_config     Config file path of kernel
--data_dir          Profile path generated by kernel
```

## 8.Jenkins流水线配置示例：

以配置文件参数优化：

```groovy
pipeline {
    agent any
    options {
        timeout(time: 1, unit: 'HOURS')
    }
    stages{
        stage('A-FOT') {
            agent {
                label 'Linux_aarch64'
            }
            steps{
				sh 'a-fot --config_file a-fot.ini'
            }
        }
    }
}
```

以命令参数优化：

```groovy
pipeline {
    agent any
    options {
        timeout(time: 1, unit: 'HOURS')
    }
    stages{
        stage('A-FOT') {
            agent {
                label 'Linux_aarch64'
            }
            steps{
				sh 'a-fot  --opt_mode AutoFDO  --gcc_path /usr --run_script /root/run.sh --build_script /root/build.sh --build_mode Wrapper --work_path ./'
            }
        }
    }
}
```

